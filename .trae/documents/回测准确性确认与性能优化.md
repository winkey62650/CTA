# 回测准确性与性能优化方案

## 1. 回测准确性评估
经过详细审查，您的回测框架在逻辑上是**准确且严谨**的：
- **无未来函数**: 信号基于当前 K 线收盘价产生，交易在下一根 K 线开盘价执行，时序逻辑正确。
- **成本模拟完善**: 考虑了手续费 (Commission)、滑点 (Slippage)、杠杆 (Leverage) 和最小下单量。
- **风控逻辑保守**: 使用 K 线的最低价/最高价 (`Low`/`High`) 进行爆仓检测，而非收盘价，这能捕捉到盘中插针导致的爆仓，非常符合实盘情况。
- **复利计算**: 资金曲线采用累乘法 (`cumprod`)，真实反映了复利增长（但也放大了回撤）。

## 2. 性能瓶颈分析
虽然逻辑正确，但发现一个**严重的性能瓶颈**：
- **问题代码**: `cta_api/function.py` 中的 `process_stop_loss_close` 函数。
- **原因**: 该函数使用 `for i in df.index` 循环遍历每一行数据。对于 1小时或更短周期的数据（数万行），这会极其缓慢，严重拖累回测速度。

## 3. 优化实施计划
我将使用 **Numba** 库对止损逻辑进行 JIT (即时编译) 加速，预计可将回测速度提升 **10-100倍**。

### 具体任务
1. **引入 Numba**: 在 `cta_api/function.py` 中引入 `numba`。
2. **重写止损函数**: 创建 `_process_stop_loss_numba` 函数，使用 `numba.jit(nopython=True)` 装饰器，将 Pandas 操作转换为高效的 Numpy 数组操作。
3. **保留接口兼容**: 保持原有的 `process_stop_loss_close` 接口不变，内部调用加速后的 Numba 函数。
